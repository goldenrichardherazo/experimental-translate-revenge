import{Metro as l,Logger as g}from"@revenge-mod/utils";import{showToast as i}from"@revenge-mod/ui";var u=new g("Questify"),d=l.findByProps("post","get","put"),f=l.findByProps("getQuest","quests"),n=new Map;function y(e){let s=e.trim().toUpperCase();return s.endsWith("QUEST")?s.slice(0,-5).trim():s}async function m(e,s){try{return await d.post({url:`/quests/${e.id}/video-progress`,body:{timestamp:s}}),!0}catch(t){return u.error(`Error reportando video: ${e.id}`,t),!1}}async function p(e,s){try{let r=(await d.post({url:`/quests/${e.id}/heartbeat`,body:{stream_key:`call:${e.id}:1`,terminal:s}})).body;return(r.progress?.PLAY_ON_DESKTOP||r.progress?.PLAY_ON_XBOX||r.progress?.PLAY_ON_PLAYSTATION||r.progress?.PLAY_ACTIVITY)?.value||0}catch(t){return u.error(`Error heartbeat: ${e.id}`,t),null}}async function _(e){let s=y(e.config.messages.questName),t=e.config.taskConfigV2?.tasks;if(!n.has(e.id))if(t?.WATCH_VIDEO||t?.WATCH_VIDEO_ON_MOBILE){let r=t.WATCH_VIDEO?.target||t.WATCH_VIDEO_ON_MOBILE?.target,o=0,a=setInterval(async()=>{o+=10,await m(e,o)&&o>=r&&(clearInterval(a),n.delete(e.id),i(`\u2705 Quest completada: ${s}`))},1e4);n.set(e.id,a),i(`\u{1F4FA} Iniciado video: ${s}`)}else{let r=t?.PLAY_ON_DESKTOP||t?.PLAY_ON_XBOX||t?.PLAY_ON_PLAYSTATION||t?.PLAY_ACTIVITY;if(!r)return;let o=setInterval(async()=>{let a=await p(e,!1);a!==null&&a>=r.target&&(await p(e,!0),clearInterval(o),n.delete(e.id),i(`\u2705 Quest completada: ${s}`))},2e4);n.set(e.id,o),i(`\u{1F3AE} Iniciado juego: ${s}`)}}var O={onStart(){u.info("Questify Lite iniciado")},onStop(){n.forEach(e=>clearInterval(e)),n.clear()},settings:()=>{let{Button:e,View:s,Text:t}=l.findByProps("Button","View","Text");return React.createElement(s,{style:{padding:20}},React.createElement(t,{style:{color:"white",marginBottom:15}},"Presiona el bot\xF3n para procesar las misiones que ya has aceptado."),React.createElement(e,{text:"Completar mis Quests",onPress:()=>{let r=f.quests,a=(r instanceof Map?Array.from(r.values()):Object.values(r)).filter(c=>c.userStatus?.enrolledAt&&!c.userStatus?.completedAt);a.length===0?i("No hay misiones aceptadas pendientes."):a.forEach(_)}}))}};export{O as default};
